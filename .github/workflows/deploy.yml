name: Python Django CI/CD vers Render

on:
  push:
    # Déclenchement automatique pour les push sur les branches de déploiement
    branches: [ master, main ] 
  pull_request:
    # Déclenchement pour les Pull Requests (pour la CI)
    branches: [ master, main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    # Ici, nous n'injectons pas les secrets de la BD ou de Django, car :
    # 1. La SECRET_KEY est en dur dans settings.py (simplifié pour le mini-projet).
    # 2. La connexion BD est en dur dans settings.py (simplifié).
    # Ces valeurs seront lues directement par l'application.

    steps:
      # Étape 1 : Récupérer le code
      - name: Checkout Repository
        uses: actions/checkout@v4 
      
      # Étape 2 : Configurer Python 3.11
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      # Étape 3 : Installer les dépendances
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        
      # Étape 4 : Exécuter les tests unitaires (CI)
      # Le test vérifie que l'application compile et que les tests passent.
      - name: Run Django Tests
        run: python manage.py test 

      # Étape 5 : Déployer sur Render (CD)
      # Utilise les secrets RENDER_API_KEY et SERVICE_ID que vous avez configurés sur GitHub.
      - name: Deploy to production (Render)
        uses: johnbeynon/render-deploy-action@v0.0.8
        with:
          service-id: ${{ secrets.SERVICE_ID }}
          api-key: ${{ secrets.COURSE_SERVICE_KEY }}

      # Note : Les migrations et la collecte des fichiers statiques DOIVENT
      # être incluses dans la "Commande de Build" (Build Command) sur Render,
      # car l'image Docker a besoin de ces fichiers avant de démarrer.
